<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladang Tagar 3 - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; }
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    Ladang Tagar 3 Report
                </a>
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "tagar3",
                "name": "Ladang Tagar 3",
                "reportInfo": "Data based on PA Report 2/2025 (Nov 2025) & Agronomy Report 2/2025 (Dec 2025).",
                "summaryMetrics": {
                    "area": { "title": "Estate Area", "lines": ["Mature: 1,548.20 ha", "Immature/New: 80.00 ha", "Total: 1,685.62 ha"] },
                    "yield": { "title": "Yield/Ha (YTD Nov)", "value": "17.00 MT", "note": "Target: 20.00 MT (Unlikely to achieve)" },
                    "cost": { "title": "FFB Cost/Tonne", "value": "RM 268.28", "note": "Actual: 268.28 | Budget: 274.58 (YTD Sep)" },
                    "weeding": { "title": "Weeding Progress", "value": "Generally Acceptable", "note": "Interrow up to date; Circle slightly behind" },
                    "manuring": { "title": "Manuring Progress", "value": "89% Completed", "note": "Expected completion by Dec 2025" }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Prod.", "value": "< 1.5 MT/md <span class='text-sm text-red-500 block font-normal mt-1'>Productivity Unsatisfactory</span>" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "High (Bagworm & Rats)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "Yield Trend", "value": "Below Expectation" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "Cost Variance", "value": "-2% (Favorable)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "> 20 Days (Delays)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov"],
                        "ffb": [2625, 2400, 2350, 2550, 2300, 2400, 2550, 2500, 2570, 2000, 2070], // Extended to Nov based on YTD 17.00 MT/ha
                        "rainfall": [216.2, 193.5, 243.5, 355.0, 98.0, 124.0, 35.5, 133.9, 145.5, 216.0, 388.5], // Actual data from AR 2/2025 Appendix 3
                        "note": "*Rainfall data updated from Agronomy Report 2/2025. Production est. based on YTD Nov yield."
                    },
                    "ageProfile": {
                        "labels": ["Young Mature (5-7 Yrs)", "Prime (8-19 Yrs)", "Old (20-25 Yrs)"],
                        "data": [14, 70, 16],
                        "title": "Tagar 3 Palm Age Distribution",
                        "note": "*Age distribution based on planting year. (AR 1/2025, Pg. 10)"
                    }
                },
                "observations": [
                    "<b>Persistent Bagworm Outbreak:</b> <i>Metisa plana</i> infestation remains significant in P00A and P16G. While treatments (trunk injection/fogging) show results, the pest remains active. <span class='observation-ref'>(AR 2/2025, Pg. 41-43; PA Report 2/2025, Pg. 33)</span>",
                    "<b>Rat Infestation Warning:</b> Rat damage in P17H has exceeded the 10% threshold. Baiting had not commenced at the time of the agronomy visit. <span class='observation-ref'>(AR 2/2025, Pg. 39)</span>",
                    "<b>Harvesting Inefficiency:</b> Intervals exceed 20 days in P00, P06, and P12. High percentage of over-ripe bunches and loose fruits noted. Harvester productivity is unsatisfactory (<1.5 MT/man-day). <span class='observation-ref'>(AR 2/2025, Pg. 20, 24)</span>",
                    "<b>Incomplete Crop Recovery:</b> Palms in ravines and heavily skirted areas (P00A, P09A) are often left unattended/unharvested. This directly contributes to yield loss. <span class='observation-ref'>(AR 2/2025, Pg. 4, 21)</span>",
                    "<b>Manuring Delays:</b> Program is 89% complete but suffered delays of up to 4 months. Delays likely caused nutrient stress and impacted bunch weight. <span class='observation-ref'>(AR 2/2025, Pg. 13, 55)</span>",
                    "<b>Blocking System:</b> Large blocks (P06B2, P09C1, P11E1, P16G) still require subdivision for effective leaf sampling. This has been advised repeatedly but not actioned. <span class='observation-ref'>(AR 2/2025, Pg. 8)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate condition is generally acceptable, but critical focus is needed on two main issues: harvester productivity and bagworm control. Recruitment of new harvesters is expected to stabilize the workforce by Jan 2026. (PA Report 2/2025, Pg. 7, 50)",
                        "Area Statement": "Total mature area remains 1,548.20 ha. Land preparation for 80 ha of new planting (Block PN25/K) is in progress at the ex-excavation area, with planting expected in December. (PA Report 2/2025, Pg. 9)",
                        "Labour Statement": "As of September, the estate had 72 harvesters against a requirement of 76 (shortage of 4). Total workforce is 120 against a requirement of 127. 4 new harvesters are expected in November. (PA Report 2/2025, Pg. 11)",
                        "Staff Establishment": "Staffing is adequate. One Field Supervisor (Mr. Gobalakrishnan) is being medically boarded out. A Cadet Assistant is currently covering the role. (PA Report 2/2025, Pg. 13-14)",
                        "General Charges": "YTD General Charges were RM 1.69M vs RM 1.91M budget (12% underspent). However, overspending occurred in electricity (26% over) and MSPO compliance costs (34% over). (PA Report 2/2025, Pg. 15)",
                        "Upkeep & Cultivation": "Weeding is on track (99% complete). However, manuring is delayed at 75% completion due to slow sub-surface application productivity (0.68 ha/man-day). Bagworm control (932 ha affected) is ongoing but infestations persist. (PA Report 2/2025, Pg. 19, 28, 33)",
                        "Harvesting and Collection": "YTD harvesting rounds were 15.5 vs 18 budget. The current interval is 16 days. Harvester productivity varies: Badang teams output is ~1.6-1.8 MT, while Mini Dumpers achieve ~1.5-2.25 MT. (PA Report 2/2025, Pg. 42-43)",
                        "Crop Production": "YTD FFB yield is 14.37 MT/ha, slightly below the budget of 14.53 MT/ha (-1%). However, yield is 2% higher than the same period last year (Sept 2024). (PA Report 2/2025, Pg. 45)",
                        "Production Cost": "YTD cost of production is RM 268.28/MT, which is favorable compared to the budget of RM 274.58/MT. (PA Report 2/2025, Pg. 47)",
                        "Vehicles Running Cost": "Vehicle running costs are within budget. (PA Report 2/2025, Pg. 48)",
                        "Capital Expenditure": "Unbudgeted fogging machines were purchased for bagworm control (RM 10,290) with Director approval. (PA Report 2/2025, Pg. 49)",
                        "Immature": "Land preparation at PN25/K (80 ha) is ongoing. EFB application is being used to revitalize poor soil conditions from previous excavation. (PA Report 2/2025, Pg. 9)"
                    },
                    "agronomy": {
                        "Executive Summary": "The visit on 10th December 2025 found that yield performance is below expectation (17.00 MT/ha YTD Nov). Crop recovery has not been maximized, particularly in old plantings (ravines), due to harvesting inefficiency. Bagworm infestations have reduced but remain a threat. Manuring progress is delayed. (AR 2/2025, Pg. 4-7)",
                        "Nutrient Inputs/Progress of Manuring": "Overall program is 89% completed as of Nov 2025. <b>Mixture A, NK1, and Kieserite</b> are 100% completed but faced delays of 2-4 months. <b>Mixture B</b> is 82% complete with significant delays in P09C, P10D, and P12F. <b>Rock Phosphate (RP)</b> is 98% complete. 8.13 MT of bio-organic fertilizer stock is recommended for supply palms. (AR 2/2025, Pg. 13-18)",
                        "Agronomic Observation": "<b>Harvesting:</b> Intervals exceed 20 days in P00A, P06B, P12F. High % of over-ripe bunches and debris-filled loose fruits. Palms in ravines (P00A, P09A) are often left unattended. Harvester productivity is low (<1.5 MT/md).<br><b>Pruning:</b> Backlogs exist in P00, P09C, P11E (85 ha). Under-pruning in ravines affects harvesting.<br><b>Nutrition:</b> Mild K deficiency in P12 & P17. Leaf N and P levels have declined.<br><b>Weeding:</b> Inter-row is up to date; circle weeding slightly behind. VOPs significant in P00 & P06.<br><b>Pests:</b> Rat damage >10% in P17H (needs baiting). Bagworm (<i>Metisa plana</i>) active in P00A & P16G despite trunk injection and fogging. Ganoderma detected in isolated areas. (AR 2/2025, Pg. 19-45)",
                        "Yield Performance": "YTD Nov yield is 17.00 MT/ha, a slight decline (-1.9%) from 17.33 MT/ha last year. Yields in P09C and P12F dropped by ~16%. The yield target of 20 MT/ha is unlikely to be achieved. Key depressive factors include deviations from the manuring schedule (up to 5 months delay), persistent Bagworm infestation reducing LAI, and harvesting inefficiencies. (AR 2/2025, Pg. 53-55)",
                        "Fertilizer Recommendation": "The 2026 Fertilizer Program has been drawn up (Appendix 1). <b>Recommendation:</b> Withdraw fertilizer for block P00B if it is scheduled for replanting in 2026/2027. Mixture fertilizers are recommended as the main source of N, K, and Mg. Rock Phosphate is recommended for all fields except P00. Kieserite is prescribed for selected blocks to improve Mg levels. (AR 2/2025, Pg. 56-59)"
                    },
                    "pinfosys": {
                        "Status": "N/A",
                        "Note": "Pinfosys Report details not available in the provided documents."
                    }
                },
                "policy": "<p>Policy cross-references are not yet available for this estate.</p>"
            };


            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate();
                    populateInternalDropdowns();
                    attachEventListeners();
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Weeding') ? 'bg-yellow-50 text-yellow-800' : 'bg-purple-50 text-purple-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall (2025)</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#fde047', '#facc15', '#eab308', '#ca8a04', '#a16207'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title, font: { size: 16 } }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);
                
                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                 if (pinfosysDiv && estateData.reports.pinfosys) {
                     if (estateData.reports.pinfosys.Status === "N/A") {
                          pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                     } else {
                         pinfosysDiv.innerHTML = Object.entries(estateData.reports.pinfosys).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                     }
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', openPolicyModal);
            }

            renderEstate();
        });
        
        function openPolicyModal() {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const estateData = {
                "name": "Ladang Tagar 3",
                 "policy": "<p>Policy cross-references are not yet available for this estate.</p>"
            };
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estateData.name}`;
            modalContent.innerHTML = estateData.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>

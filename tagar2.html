<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladang Tagar 2 - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; }
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    Ladang Tagar 2 Report
                </a>
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "tagar2",
                "name": "Ladang Tagar 2",
                "reportInfo": "Data based on Plantation Advisory Report 1/2026 (Visit: 22 Jan 2026) and Agronomy Report 2/2025 (Visit: 29 Oct 2025).",
                "summaryMetrics": {
                    "area": { "title": "Estate Area", "lines": ["Total Planted: 734.35 ha", "Mature: 639.35 ha", "Immature: 95.00 ha"] },
                    "yield": { "title": "Yield/Ha (Actual vs Budget)", "value": "13.59 / 18.55 MT", "note": "YTD December 2025" },
                    "cost": { "title": "FFB Cost/Tonne (Actual vs Budget)", "value": "RM 342.46 / RM 283.08", "note": "Ex-Estate, YTD Nov 2025" },
                    "weeding": { "title": "Weeding Progress", "value": "82% Completed", "note": "Shortage of sprayers" },
                    "manuring": { "title": "Manuring Progress (2025)", "value": "100% Completed", "note": "Completed by Dec 2025" }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Labour Ratio", "value": "1:15 ha", "note": "Shortage of 15 workers" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "Active", "note": "Rat & Bagworm in P18F" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "OER % (YTD)", "value": "18.76%", "note": "YTD Nov 2025" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Prod.", "value": "Low", "note": "< Basic Wage Earnings" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "15 Days", "note": "Acceptable (Low Crop)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>", "label": "Nutrient Status", "value": "Mg Def.", "note": "Deficiency in P18F" }
                ],
                "chartData": {
                    "production": { 
                        "labels": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct"], 
                        "ffb": [598.33, 628.80, 661.25, 721.36, 652.63, 789.22, 766.19, 711.40, 817.96, 814.08], 
                        "rainfall": [330, 259, 261, 351, 160, 142, 35, 150, 170, 207], 
                        "note": "*Chart data available YTD Oct 2025. Total Production 2025: 8,675.13 MT (Source: PA Report 1/2026)" 
                    },
                    "ageProfile": { 
                        "labels": ["0-3 Yrs (Immature)", "4-7 Yrs", "8-19 Yrs", "20-25 Yrs", ">26 Yrs"], 
                        "data": [12.3, 25.7, 26.2, 35.8, 0], 
                        "title": "Tagar 2 Palm Age Distribution", 
                        "note": "*Age distribution based on planting year." 
                    }
                },
                "observations": [
                    "<b>Severe Labour Shortage & Productivity:</b> Shortage of 15 workers (8 harvesters) is critical. Mechanization has ceased, requiring a higher labour ratio (1:17 ha). Productivity is low, with earnings often below minimum wage. <span class='observation-ref'>(PA Report 1/2026, Pg. 10-11, 50)</span>",
                    "<b>Yield Shortfall:</b> 2025 yield (13.59 MT/ha) is 27% below budget. Bunch weights in older plantings have dropped, likely due to harvesting delays/over-ripeness. <span class='observation-ref'>(PA Report 1/2026, Pg. 39-40)</span>",
                    "<b>Pest Outbreaks (Rat & Bagworm):</b> Active rat damage (>10%) and fresh bagworm outbreaks recorded in P18F. Immediate baiting and census are required. <span class='observation-ref'>(PA Report 1/2026, Pg. 30, 33)</span>",
                    "<b>Disease (Ganoderma):</b> Upper stem rot infections observed in P00A and P01B. Monitoring required. <span class='observation-ref'>(PA Report 1/2026, Pg. 34)</span>",
                    "<b>Infrastructure Issues (Roads & Cattle):</b> No road grading done in 2025 due to low contract rates; roads are in poor condition. Stray cattle persist despite court orders. <span class='observation-ref'>(PA Report 1/2026, Pg. 26, 35)</span>",
                    "<b>Agronomic Deficiencies:</b> Magnesium deficiency in P18F (hilly areas). Manuring quality in steep terrain (P00C) is challenging. <span class='observation-ref'>(Agronomy Report 2/2025)</span>",
                    "<b>Weeding & VOPs:</b> Inter-rows in P20 show abundant woodies and Volunteer Oil Palms (VOPs). A dedicated eradication round is recommended. <span class='observation-ref'>(PA Report 1/2026, Pg. 17)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate faces critical operational challenges primarily due to a shortage of 15 workers, including 8 harvesters and 3 sprayers. This has resulted in very low harvester productivity and high turnover. Management is urged to focus on recruitment to stabilize the workforce. Additionally, the estate has discontinued mechanized in-field collection, reverting to wheelbarrows. Issues with stray cattle persist despite court orders. <span class='observation-ref'>(PA Report 1/2026, Pg. 50-51, 35)</span>",
                        "Area Statement": "The total planted area stands at 734.35 ha, comprising 639.35 ha (82.98%) of mature palms and 95.00 ha (12.33%) of immature palms. Non-planted areas include 23.95 ha of roads and 11.00 ha for buildings/others. No changes in the area statement were recorded. <span class='observation-ref'>(PA Report 1/2026, Pg. 9)</span>",
                        "Labour Statement": "The estate is short of 15 workers (Actual: 49 vs Required: 64). Specifically, there is a shortage of 8 harvesters based on a 1:20 ha ratio. However, since mechanized collection has ceased and wheelbarrows are now used, the ratio should be revised to 1:17 ha, increasing the requirement to 43 harvesters. A quota for 100 workers has been applied for, pending Labour Office verification. Current worker-to-land ratio is 1:15 ha. <span class='observation-ref'>(PA Report 1/2026, Pg. 10-11)</span>",
                        "Staff Establishment": "The staff establishment is generally adequate. The team consists of one Senior Assistant Manager (En. Mohd Shalihuddin), a Chief Clerk, and three Field Supervisors. However, the Office Clerk position remains vacant. <span class='observation-ref'>(PA Report 1/2026, Pg. 12)</span>",
                        "General Charges": "Overall expenditure was underspent by 10%. However, 'Other Expenditures' saw a 7% overspend due to a significant hike in recruitment immigration costs (from RM500 to RM2,500 per worker). Quit rent was overspent by 428% as it was charged to HQ. <span class='observation-ref'>(PA Report 1/2026, Pg. 13)</span>",
                        "Upkeep & Cultivation": "<b>Weeding:</b> Circle spraying is 82% complete; selective spraying is 88%. Inter-rows in P20 show abundant woodies and VOPs; a dedicated round for VOP eradication is recommended. <b>Manuring:</b> 100% completed by December using broadcasting (output 20 bags/man-day). It is recommended to use wheelbarrows in undulating areas to boost productivity. Mg deficiency noted in P18F. <b>Pruning:</b> 78% completed. Progress hampered by harvester shortage. Fractured fronds and unstacked fronds (P00A) require attention. <b>Roads:</b> No grading was done in 2025 as contractors rejected the low rate of RM12/chain. Roads are uneven with deep ruts. <b>Drains:</b> Desilting is satisfactory but shows high sand content. <b>Pests:</b> Fresh rat damage (>10%) and bagworm outbreaks found in P18F. Ganoderma (upper stem rot) seen in P00A/P01B. Stray cattle problem persists despite court orders. <span class='observation-ref'>(PA Report 1/2026, Pg. 14-35)</span>",
                        "Harvesting and Collection": "Harvesting cost is acceptable, but productivity is concerningly low, with many harvesters earning below the minimum wage. The estate achieved 22 rounds against a budget of 24, with intervals averaging 15 days. The reversion to wheelbarrows was necessary as previous machines were in poor condition and contractors could not afford replacements. Sporadic uncollected loose fruits were observed in circles. <span class='observation-ref'>(PA Report 1/2026, Pg. 36-38)</span>",
                        "Crop Production": "YTD December yield was 13.59 MT/ha, which is 27% below the budget of 18.55 MT/ha and 5% lower than the same period in 2024 (14.32 MT/ha). Bunch weights dropped in 2000-2002 plantings, likely due to over-ripeness from extended intervals. Abnormal bunch weight differences were noted in 2016, 2018, and 2020 plantings, suggesting inaccurate bunch counting. <span class='observation-ref'>(PA Report 1/2026, Pg. 39-41)</span>",
                        "Production Cost": "The cost of production stands at RM 342.46/MT against a budget of RM 286.50/MT. The variance is primarily driven by the low crop yield achieved. <span class='observation-ref'>(PA Report 1/2026, Pg. 42)</span>",
                        "Vehicles & Machinery": "The New Holland tractor (BPD1250) is underutilized for manuring tasks, resulting in high running costs per hour. Management is advised to review the budgeted running hours to align with actual usage. <span class='observation-ref'>(PA Report 1/2026, Pg. 43)</span>",
                        "Immature (PR22/H)": "Weeding (circle spraying) is 51% complete. Manuring is 100% complete. Basal pruning commenced in March 2025 and must be completed by March 2026 as the area was declared mature in Jan 2026. Scout harvesting yielded 1.28 MT/ha. Sporadic rat damage was observed, and some runts need replacing. <span class='observation-ref'>(PA Report 1/2026, Pg. 45-49)</span>"
                    },
                    "agronomy": {
                        "Executive Summary": "Report 2/2025 (Visit Oct 29, 2025). Manuring is 88% complete but slightly behind schedule. Crop recovery is incomplete in old plantings (ravines). Yield performance is poor but improving. Pests (Bagworm/Rat) require attention. <span class='observation-ref'>(Agronomy Report 2/2025, Pg. 4-6)</span>",
                        "Nutrient Inputs/Progress of Manuring": "88% completion as of Oct 2025. NK1 and RP applications pending in P12, P16, P18. Expected completion by end of Nov 2025. Application quality in P00C acceptable but difficult due to terrain. <span class='observation-ref'>(Agronomy Report 2/2025, Pg. 10-11)</span>",
                        "Agronomic Observation": "<b>Mature:</b> Harvesting intervals >15 days. Crop loss in ravines (P00/P01). Pruning delayed (P00 63%). <b>Young Mature (P18/P20):</b> Poor appearance in hilly P18F1. Weeding delays. <b>Immature (P22):</b> Vacant areas need filling. Bagworm infestation. <span class='observation-ref'>(Agronomy Report 2/2025, Pg. 13-41)</span>",
                        "Yield Performance": "YTD Oct 2025 yield is 12.23 MT/ha, lower than 2024 (13.4 MT/ha est). Yield limiting factors: Extended harvesting intervals, manuring deviations, and past pest damage. <span class='observation-ref'>(Agronomy Report 2/2025, Pg. 47-48)</span>",
                        "Fertilizer Recommendation": "2026 program provided in Appendix 1. NK and Mixture B recommended. RP unnecessary for older plantings (P00-P02). Corrective Kieserite for selected blocks. <span class='observation-ref'>(Agronomy Report 2/2025, Pg. 50)</span>"
                    },
                    "pinfosys": "Not Available"
                },
                "policy": "<div class='policy-item'><p class='font-semibold'>Bagworm Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Bagworm-01:</b> Census must be conducted monthly. If infestation > 10 larvae/leaf (lower frond), immediate trunk injection or spraying is required.</p></div><div class='policy-item'><p class='font-semibold'>Rat Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-02b:</b> Census required quarterly. If damage threshold > 10%, immediate baiting campaigns must be instituted. (Relevant to P18F).</p></div><div class='policy-item'><p class='font-semibold'>Harvesting Productivity</p><p class='text-sm text-gray-600'><b>Policy Ref: HR-PROD-01:</b> Harvesters falling below basic wage earnings require review of block allocation and crop density to ensure fair income and retention.</p></div>"
            };

            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate();
                    populateInternalDropdowns();
                    attachEventListeners();
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetrics = estate.summaryMetrics;
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                     const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Weeding') ? 'bg-yellow-50 text-yellow-800' : 'bg-purple-50 text-purple-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass} shadow-sm"><h3 class="text-sm font-semibold text-gray-500">${metric.title}</h3><div class="mt-1">${metric.lines.map(line => `<p class="text-gray-900 font-medium">${line}</p>`).join('')}</div></div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass} shadow-sm"><h3 class="text-sm font-semibold text-gray-500">${metric.title}</h3><p class="text-3xl font-bold mt-1">${metric.value}</p><p class="text-xs mt-1 opacity-80">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div>
                            <p class="text-sm text-gray-500">${metric.label}</p>
                            <p class="font-bold text-lg">${metric.value}</p>
                            ${metric.note ? `<p class="text-xs text-gray-500">${metric.note}</p>` : ''}
                        </div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall (2025)</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                             <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#c026d3', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#fde047', '#facc15', '#eab308', '#ca8a04', '#a16207'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title, font: { size: 16 } }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);
                
                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }

                if (pinfosysDiv && estateData.reports.pinfosys === "Not Available") {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', openPolicyModal);
            }

            renderEstate();
        });
        
        function openPolicyModal() {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const estateName = "Ladang Tagar 2";
            // We reuse the policy data from the estateData structure via the script tag regex or hardcoded fallback
            const policyHTML = document.querySelector('script').textContent.match(/policy": "(.*)"/)?.[1] || "<div class='policy-item'><p class='font-semibold'>Bagworm Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Bagworm-01:</b> Census must be conducted monthly.</p></div>";
            
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estateName}`;
            
            // Hardcoded for this specific render to ensure it matches the new findings (Rat & Bagworm)
            modalContent.innerHTML = `<div class='policy-item'><p class='font-semibold'>Bagworm Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Bagworm-01:</b> Census must be conducted monthly. If infestation > 10 larvae/leaf (lower frond), immediate trunk injection or spraying is required.</p></div><div class='policy-item'><p class='font-semibold'>Rat Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-02b:</b> Census required quarterly. If damage threshold > 10%, immediate baiting campaigns must be instituted. (Relevant to P18F).</p></div><div class='policy-item'><p class='font-semibold'>Harvesting Productivity</p><p class='text-sm text-gray-600'><b>Policy Ref: HR-PROD-01:</b> Harvesters falling below basic wage earnings require review of block allocation and crop density to ensure fair income and retention.</p></div>`;
            
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>

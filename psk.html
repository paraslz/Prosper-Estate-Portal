<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSK Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        /* Active dropdown button color from idealestate.html */
        .dropdown-btn.active { background-color: #14532d; } 
        /* Policy item border from idealestate.html */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; } 
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        /* Observation reference style from idealestate.html */
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    PSK Estate Report
                </a>
            </div>
            <!-- Back button style from idealestate.html -->
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            // This data is updated with Agronomy Report 2/2025 and blended with existing PA Report 2/2025 data.
            const estateData = {
                "id": "psk",
                "name": "PSK Estate",
                "reportInfo": "Data based on Agronomy Report (2/2025, visit on 24th September 2025) and PA Report (2/2025, visit on 6th August 2025).",
                "summaryMetrics": {
                    "area": { 
                        "title": "Estate Area", 
                        "lines": ["Mature: 1,999.83 ha", "Immature: 0.00 ha", "Total: 1,999.83 ha"] 
                        // (AR 2/2025, Pg. 8)
                    },
                    "yield": { 
                        "title": "Yield/Ha (Actual vs Last Year)", 
                        "value": "7.88 / 8.80 MT", 
                        "note": "YTD August 2025" 
                        // (AR 2/2025, Pg. 36)
                    },
                    "cost": { 
                        "title": "FFB Cost/Tonne (Actual vs Budget)", 
                        "value": "RM 260.60 / RM 340.06", 
                        "note": "YTD June 2025" 
                        // (Preserved from PA Report 2/2025)
                    },
                    "weeding": { 
                        "title": "Weeding Progress (YTD Aug 2025)", 
                        "value": "Circle: 35%, Inter-row: 68%", 
                        "note": "Behind schedule" 
                        // (AR 2/2025, Pg. 28)
                    },
                    "manuring": { 
                        "title": "Manuring Progress (YTD Aug 2025)", 
                        "value": "35% (Mix B), 52% (RP)", 
                        "note": "Significantly behind schedule" 
                        // (AR 2/2025, Pg. 10)
                    }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Labour Ratio", "value": "1:33 ha (Short 28 Harvesters)" }, // (AR 2/2025, Pg. 37)
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "Rat Damage at 1-3%" }, // (AR 2/2025, Pg. 34)
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "OER %", "value": "15.82% (Actual)" }, // (Preserved from PA Report 2/2025)
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Prod.", "value": "1.02 - 1.44 MT/md" }, // (AR 2/2025, Pg. 38)
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "Extended up to 30 days" }, // (AR 2/2025, Pg. 16)
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>", "label": "Nutrient Status", "value": "Suboptimal (Low P & K)" } // (AR 2/2025, Pg. 19-20)
                ],
                "chartData": {
                    "production": { 
                        "labels": ["Jan-25", "Feb-25", "Mar-25", "Apr-25", "May-25", "Jun-25", "Jul-25", "Aug-25", "Sep-25", "Oct-25", "Nov-25", "Dec-25"], 
                        "ffb": [10903.58, 0, 0, 0, 0, 0, 16051, 16051, 16051, 16051, 16051, 16051], // FFB data preserved from PA Report
                        "rainfall": [276.0, 120.5, 282.0, 324.0, 352.0, 155.0, 36.0, 248.0, 0, 0, 0, 0], // Rainfall data from AR 2/2025 (Pg. 43)
                        "note": "*FFB data from PA Report (YTD June 2025 + Budget). Rainfall data from Agronomy Report 2/2025 (YTD Aug 2025)." 
                    },
                    "ageProfile": { 
                        "labels": ["0-3 Years", "4-7 Years", "8-19 Years", "20-25 Years", ">26 Years"], 
                        "data": [0.12, 0, 82.8, 16.28, 0], // Data preserved from PA Report
                        "title": "PSK Estate Palm Age Distribution (ha)", 
                        "note": "*83% of palms are in prime age category (8-19 years)." 
                    }
                },
                "observations": [
                    "<b>Critical Labour Shortage:</b> A shortfall of 28 harvesters <span class='observation-ref'>(AR, Pg. 37)</span> and 15 sprayers <span class='observation-ref'>(PA Report, Pg. 10)</span> is the root cause of low productivity, low wages, and delays in all major field operations.",
                    "<b>Delayed Field Work (Manuring & Weeding):</b> The 2025 manuring program is critically behind schedule (35-52% complete), with the final round withdrawn <span class='observation-ref'>(AR, Pg. 10-11)</span>. Weeding is also delayed (35% circle complete), impacting field conditions <span class='observation-ref'>(AR, Pg. 28)</span>.",
                    "<b>Extended Harvesting & Low Yield:</b> Harvesting intervals are extended up to 30 days <span class='observation-ref'>(AR, Pg. 16)</span>, resulting in over-ripe bunches and crop loss. YTD yield is 12% below last year, directly linked to harvester shortage and incomplete manuring <span class='observation-ref'>(AR, Pg. 36-38)</span>.",
                    "<b>Severe Pruning Backlog:</b> The pruning program is only 43% complete, with significant under-pruned conditions in Blocks A and F, which hinders harvesting access and palm health <span class='observation-ref'>(AR, Pg. 21-23)</span>.",
                    "<b>Suboptimal Palm Nutrient Status:</b> Leaf analysis shows nutrient levels are not optimal, with widespread low Phosphorus (P) and marginally low Potassium (K), exacerbated by the incomplete fertilizer program <span class='observation-ref'>(AR, Pg. 19-20)</span>.",
                    "<b>Low Worker Productivity:</b> Low productivity in spraying <span class='observation-ref'>(PA Report, Pg. 16)</span> and harvesting (1.02-1.44 MT/md) <span class='observation-ref'>(AR, Pg. 38)</span> has led to earnings below basic wage, fueling high worker turnover <span class='observation-ref'>(PA Report, Pg. 10)</span>."
                ],
                "reports": {
                    "agronomy": {
                        "Executive Summary": "Palm census is slow. Manuring is behind schedule (Pg. 4). Harvesting intervals are extended, leading to over-ripe bunches (Pg. 4, 16). Pruning and weeding are behind schedule (Pg. 5). Rat damage is under control (Pg. 6). Yield is unsatisfactory due to harvester shortage, flooding, and manuring delays (Pg. 6).",
                        "Nutrient inputs/progress of manuring": "Progress is 35% for Mix B and 52% for RP, delayed by flooding and low manpower (Pg. 10). The final 2025 round of Mix B is proposed to be withdrawn (Pg. 11). Application quality was uneven (lumpy, narrow banding) (Pg. 12). The fertilizer store is in satisfactory condition (Pg. 14).",
                        "Agronomic observation": "Harvesting intervals remain unsatisfactory, up to 30 days in Sep, causing overripe bunches (Pg. 15-17). Leaf analysis shows suboptimal nutrient status, with low P and marginally low K (Pg. 19-20). Palm appearance is less than satisfactory, especially in peat areas (Pg. 20). Pruning is slow (43% complete) with under-pruning in Blocks A & F (Pg. 21-23). Weeding is behind schedule (35% circle, 68% inter-row) (Pg. 28). Rat damage is low (1-3%) (Pg. 34), but barn owl box occupancy is poor (45%) (Pg. 34-35). Ganoderma is under control (Pg. 35).",
                        "Yield performance": "YTD Aug 2025 yield is 7.88 MT/ha, a 12% decline from 2024 (Pg. 36). This is attributed to a harvester shortage (28 shortfall), prolonged flooding, and the incomplete fertilizer program (Pg. 37-38). Harvester productivity (1.02-1.44 MT/md) and average bunch weight (15.48 kg) are low (Pg. 38-39).",
                        "Fertilizer recommendation": "The final 2025 Mix B round will be withdrawn (Pg. 40). The 2026 program is adjusted (Appendix 1) and must be strictly followed to prevent further yield reductions (Pg. 40)."
                    },
                    "plantation": {
                        "Executive Summary": "The estate faces a critical shortage of 23 harvesters and 15 sprayers, leading to high turnover and low wages. Priority must be given to clearing Volunteer Oil Palms (VOPs) and Stenochlaena in low-lying areas. A task force is urgently needed to complete a significant corrective pruning backlog by October. Harvester productivity needs to be increased. (PA Report, Pg. 50-51)",
                        "Area statement": "Total mature planted area is 1,999.83 ha. There has been no change in the area statement. (PA Report, Pg. 9)",
                        "Labour Statement": "A critical shortage of 23 harvesters (actual ratio 1:33 ha vs. 1:24 ha required) and 15 sprayers exists. The overall worker to land ratio is 1:25 ha, indicating a severe shortage. (PA Report, Pg. 10-11)",
                        "Staff Establishment": "The staff establishment is considered sufficient, with 1 manager, 3 executives, 5 field staff, and 2 clerks. However, the majority of staff are inexperienced, having been on the estate for less than 3 years. (PA Report, Pg. 12-13)",
                        "General Charges": "Expenditure was underspent by 49% as of June and is considered under control. (PA Report, Pg. 14)",
                        "Upkeep Cultivation": "Circle spraying is 39% complete and selective spraying is 57% complete, both delayed by flooding and sprayer shortages (Pg. 16, 20). The manuring program is only 33% complete due to flooding (Pg. 29). A significant corrective pruning backlog of 1,298 ha exists, with only 13% of the annual program done (Pg. 30).",
                        "Harvesting and Collection": "The harvesting cost was RM 78.90/tonne. The average harvesting interval was 16 days, with only 9 out of 12 budgeted rounds completed. Harvester productivity is between 1.7 to 2.0 tons/man-day. (PA Report, Pg. 41-42)",
                        "Crop Production": "Yield achieved was 5.45 ton/ha as of June, 32% below budget. The shortfall is due to flooding and harvester shortage. (PA Report, Pg. 44)",
                        "Production Cost": "The cost of production was RM 260.60/tonne FFB. This is acceptable as it's due to underspending in General Charges and Upkeep. (PA Report, Pg. 47)",
                        "Vehicles Running Cost": "The Vehicle Running Account for the Hilux was satisfactory. (PA Report, Pg. 48)",
                        "Capital Expenditure": "Capital expenditure was underspent as of June. (PA Report, Pg. 49)",
                        "Immature": "N/A (0.00 ha of immature palms). (PA Report, Pg. 9)"
                    },
                    "pinfosys": "Not Available"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Harvester Productivity & Crop Recovery</p><p class='text-sm text-gray-600'><b>Policy 12.6:</b> Maintain high harvesting standards; collect all loose fruits. (Pg. 128)</p><p class='text-sm text-gray-600'><b>Policy 12.3:</b> Ideal harvesting interval 10-12 days. (Pg. 127)</p></div> <div class='policy-item'><p class='font-semibold'>Delayed Manuring Program</p><p class='text-sm text-gray-600'><b>Policy 8.4.1 A:</b> Ensure timely fertilizer application, avoiding heavy/low rainfall periods; proper planning. (Pg. 82-83)</p></div> <div class='policy-item'><p class='font-semibold'>Pruning Backlog & Canopy Management</p><p class='text-sm text-gray-600'><b>Policy 11.01:</b> Pruning is for practical purposes; avoid over-pruning. (Pg. 124)</p><p class='text-sm text-gray-600'><b>Policy 11.1.2 a:</b> Retain two fronds below lowest bunches. (Pg. 124)</p><p class='text-sm text-gray-600'><b>Policy 11.3:</b> Stack pruned fronds neatly in inter-lines. (Pg. 125)</p></div> <div class='policy-item'><p class='font-semibold'>High Rat Damage</p><p class='text-sm text-gray-600'><b>Policy 9.1.3 iii:</b> Conduct regular rat baiting if damage >5%. (Pg. 118)</p><p class='text-sm text-gray-600'><b>Policy 9.1.3 i:</b> Encourage barn owls; use warfarin baits if needed. (Pg. 120)</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {}; // To keep track of created charts for proper destruction
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---

            /**
             * Renders the full report for the estate.
             */
            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                
                // Use a short timeout to ensure the DOM is updated before initializing charts and events
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            /**
             * Creates the HTML string for the estate's report.
             * @param {object} estate - The data object for a single estate.
             * @returns {string} The complete HTML for the estate's report view.
             */
            function createEstateHTML(estate) {
                // Styling logic matched to idealestate.html semantic colors
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Weeding') ? 'bg-yellow-50 text-yellow-800' : 'bg-purple-50 text-purple-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production (PA) vs Rainfall (Agro) 2025</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues (Blended)</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        
                        <!-- Modal button styled like idealestate.html -->
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>

                            <!-- Pinfosys dropdown added from idealestate.html template -->
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            /**
             * Initializes charts for the estate.
             */
            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 }, // Line color from idealestate.html
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCtx] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#E5E7EB', '#60A5FA', '#10B981', '#F59E0B', '#EF4444'], hoverOffset: 4 }] // Original semantic colors
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title, font: { size: 16 } }, legend: { position: 'right' } } }
                    });
                }
            }
            
            /**
             * Populates the content of the collapsible report sections.
             */
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy)
                        .map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation)
                        .map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                // Populate Pinfosys N/A
                if (pinfosysDiv && estateData.reports.pinfosys === "Not Available") {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }
            }

            /**
             * Attaches event listeners for dropdowns and modal buttons.
             */
            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });

                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => {
                    openPolicyModal(estateData);
                });
            }


            // --- INITIALIZATION ---
            renderEstate();
        });
        
        /**
         * Opens the policy modal with data from the estate.
         */
        function openPolicyModal(estateData) {
            document.getElementById('modalTitle').innerText = `Agricultural Policy Cross-Reference: ${estateData.name}`;
            document.getElementById('modalContent').innerHTML = estateData.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        /**
         * Closes the policy modal.
         */
        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>

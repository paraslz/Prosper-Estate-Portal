<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sungai Pertang Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #4a5568; }
        .policy-item { border-left: 3px solid #6366f1; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    Sungai Pertang Estate Report
                </a>
            </div>
            <a href="estates.html" class="text-indigo-600 hover:text-indigo-800 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "sgpertang",
                "name": "Ladang Sungai Pertang",
                "reportInfo": "Data based on Agronomy Report 1/2025 (Visit: 13th August 2025).",
                "summaryMetrics": {
                    "area": { "title": "Estate Area", "lines": ["Total Oil Palm: 1,228.00 ha", "Mature: 1,030.00 ha", "Immature: 100.00 ha", "Replanting: 98.00 ha"] },
                    "yield": { "title": "Yield/Ha (Actual vs Budget)", "value": "N/A", "note": "YTD data not available" },
                    "cost": { "title": "FFB Cost/Tonne (Actual vs Budget)", "value": "N/A", "note": "Pinfosys data not available" },
                    "weeding": { "title": "Weeding Quality", "value": "Needs Improvement", "note": "Overgrown weeds and over-spraying issues noted." },
                    "manuring": { "title": "Manuring Progress (2025)", "value": "Delayed", "note": "Multiple applications behind schedule as of July." }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Harvesting Delays", "value": "Intervals >20 days in old plantings." },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h2M9 7h6m-3 3v4' /></svg>`, "label": "Pruning Backlog", "value": "Under-pruned palms in old plantings." },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h8a1 1 0 001-1z' /></svg>`, "label": "Weed Control", "value": "Quality needs improvement." },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a4 4 0 00-4-4H9.88a4 4 0 00-3.78 2.41m-1.12-2.41a4 4 0 00-4 4v2m16-10a4 4 0 01-4 4H7a4 4 0 01-4-4' /></svg>`, "label": "Palm Age Profile", "value": "Less than ideal; >50% old plantings." },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m5 4v4m-2-2h4M5 3a2 2 0 00-2 2v1c0 1.1.9 2 2 2h1V3H5zM3 5a2 2 0 012-2h1v4H3V5zm10-2a2 2 0 00-2 2v1c0 1.1.9 2 2 2h1V3h-1zm-2 2a2 2 0 012-2h1v4h-3V5zm-4 8a2 2 0 00-2 2v1c0 1.1.9 2 2 2h1v-4H7zm-2 2a2 2 0 012-2h1v4H5v-1c0-1.1.9-2 2-2zm10 0a2 2 0 00-2 2v1c0 1.1.9 2 2 2h1v-4h-1zm-2 2a2 2 0 012-2h1v4h-3v-1c0-1.1.9-2 2-2z' /></svg>`, "label": "Barn Owl Occupancy", "value": "Low at 40%." },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 11c0 3.517-1.009 6.789-2.756 9.354-1.748-2.565-2.756-5.837-2.756-9.354C6.488 7.483 8.991 5 12 5s5.512 2.483 5.512 6.146c0 3.517-1.009 6.789-2.756 9.354C13.009 17.789 12 14.517 12 11z' /></svg>`, "label": "Oryctes Infestation", "value": "Needs control in PR24." }
                ],
                "chartData": {
                    "production": {
                        "labels": ["Jun-25", "Jul-25"],
                        "ffb": [0, 2032],
                        "rainfall": [0, 0],
                        "note": "*FFB production data from June-July 2025. Rainfall data not available."
                    },
                    "ageProfile": {
                        "labels": ["0-3 Yrs (Replanting)", "4-7 Yrs (Young Mature)", "8-19 Yrs (Prime)", "20-25 Yrs (Old)", ">26 Yrs (Old)"],
                        "data": [16, 16, 17, 33, 18],
                        "title": "Sg Pertang Palm Age Distribution (2025)",
                        "note": "*Based on Agronomy Report 1/2025, pg. 9."
                    }
                },
                "observations": [
                    "<b>Harvesting Delays & Crop Loss:</b> Harvesting intervals have extended beyond 20 days in old plantings, leading to over-ripe bunches and crop loss, especially in neglected ravine areas. (AR Pg. 17-19, 53)",
                    "<b>Pruning Program Not Started:</b> No pruning has been done since the management takeover, resulting in under-pruned conditions in old plantings that obstruct harvesting. (AR Pg. 4, 22-23)",
                    "<b>Delayed Manuring Program:</b> As of July 2025, only Borate application is complete. Urea, MOP, NK Mixture, and Kieserite applications are behind schedule, potentially impacting palm nutrition. (AR Pg. 14)",
                    "<b>Suboptimal Weeding Quality:</b> Despite progress being reported, field conditions show overgrown broadleaf weeds, signs of over-spraying in some areas, and incomplete eradication of weeds, indicating a need for better supervision and technique. (AR Pg. 30-32)",
                    "<b>Less Than Ideal Palm Age Profile:</b> Over half of the estate's palms are old (>20 years) and in a descending yield stage. Only 17% are in their prime, which is far below the ideal of 48%. (AR Pg. 9)",
                    "<b>Low Barn Owl Occupancy:</b> The occupancy rate of barn owl boxes is low at 40%, which could lead to higher rat populations if not addressed. (AR Pg. 36)"
                ],
                "reports": {
                    "agronomy": { 
                        "Executive Summary": "The palm age profile is less than ideal with over half the plantings being old. Key immediate issues are significant harvesting delays, a complete lack of pruning progress since takeover, and the need to improve weeding quality. Mild nutrient deficiency symptoms were observed, and leaf sampling is planned. The 2026 fertilizer program has been drafted. (Agronomy Report, Pg. 4-6)",
                        "Nutrient Inputs/Progress of Manuring": "The 2025 manuring program is behind schedule. As of July, only Borate application was completed. Applications for Urea, MOP, NK Mixture, and Kieserite were all delayed. A revised schedule has been advised. (Agronomy Report, Pg. 14-16)",
                        "Agronomic Observation": "Harvesting intervals in old plantings exceed 20 days, causing over-ripe bunches and crop loss in ravines. Loose fruit collection is incomplete. No pruning has been done, leading to under-pruned conditions. Frond stacking quality is substandard. Weeding quality is poor, with overgrown weeds and over-spraying noted. (Agronomy Report, Pg. 17-35)",
                        "Yield Performance": "Harvesting under new management began in June 2025, with July production at 2032 MT (~2mt/ha), which is acceptable. However, there is significant room for improvement by resolving harvesting delays, addressing the pruning backlog, and improving weeding standards. The targeted yield is 20-25 MT/ha. (Agronomy Report, Pg. 52-55)",
                        "Fertilizer Recommendation": "The 2026 fertilizer program has been drafted for budgeting purposes and will be reviewed. It is recommended to use 600g of Controlled Release Fertilizer for new supply palms. (Agronomy Report, Pg. 57)"
                    },
                    "plantation": { 
                        "Executive Summary": "N/A",
                        "Area Statement": "N/A",
                        "Labour Statement": "N/A",
                        "Staff Establishment": "N/A",
                        "General Charges": "N/A",
                        "Upkeep and Cultivation": "N/A",
                        "Harvesting and Collection": "N/A",
                        "Crop Production": "N/A",
                        "Production Cost": "N/A",
                        "Vehicles Running Cost": "N/A",
                        "Capital Expenditure": "N/A",
                        "Immature": "N/A"
                    },
                    "pinfosys": {
                        "CEO Financial Summary": "N/A",
                        "Summary of Oil Palm Expenditure": "N/A"
                    }
                },
                "policy": "<p>No specific policy cross-references were available in the provided reports.</p>"
            };

            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate();
                    populateInternalDropdowns();
                    attachEventListeners();
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-red-50 text-red-800' :
                                       metric.title.includes('Weeding') ? 'bg-yellow-50 text-yellow-800' : 'bg-purple-50 text-purple-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#c026d3', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336', '#9C27B0'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title, font: { size: 16 } }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv) {
                    plantationDiv.innerHTML = `<p class="text-sm text-gray-600">Plantation Advisory Report not available.</p>`;
                }
                if (pinfosysDiv) {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">Pinfosys Report not available.</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', openPolicyModal);
            }

            renderEstate();
        });
        
        function openPolicyModal() {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const policyData = "<p>No specific policy cross-references were available in the provided reports.</p>";
            modalTitle.innerText = `Agricultural Policy Cross-Reference: Ladang Sungai Pertang`;
            modalContent.innerHTML = policyData;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>

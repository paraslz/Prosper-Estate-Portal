<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladang Simpai 1 - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #4a5568; }
        .policy-item { border-left: 3px solid #6366f1; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    Ladang Simpai 1 Report
                </a>
            </div>
            <a href="estates.html" class="text-indigo-600 hover:text-indigo-800 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "simpai1",
                "name": "Ladang Simpai 1",
                "reportInfo": "Data based on Agronomy Report 1/2025 (Visit: June 2025) & Plantation Advisory Report 1-2025 (Visit: June 2025).",
                "summaryMetrics": {
                    "area": { "title": "Estate Area", "lines": ["Total Plantable: 1,249.22 ha", "Mature: 948.74 ha", "Immature: 300.48 ha"] },
                    "yield": { "title": "Yield/Ha (YTD)", "value": "5.94 MT", "note": "As of May 2025" },
                    "cost": { "title": "FFB Cost/Tonne", "value": "RM 323.27", "note": "As of May 2025" },
                    "weeding": { "title": "Weeding Progress", "value": "Behind Schedule", "note": "Circle Spraying behind schedule" },
                    "manuring": { "title": "Manuring Progress", "value": "Slower than expected", "note": "As of May 2025" }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Labour Shortage", "value": "Sprayers Needed" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "Rat & Rhino Beetle Damage Noted" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "OER %", "value": "16.00% (CPO)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Prod.", "value": "Needs Improvement" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "Acceptable (<15 days)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>", "label": "Nutrient Status", "value": "Deficiencies Noted" }
                ],
                "chartData": {
                    "production": { "labels": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], "ffb": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "rainfall": [238, 98, 224, 548, 217, 0, 0, 0, 0, 0, 0, 0], "note": "*Production & Rainfall data as of May 2025 (from Agronomy Report)." },
                    "ageProfile": { "labels": ["Immature (24%)", "Young Mature (25%)", "Prime Mature (48%)", "Old Mature (3%)"], "data": [24, 25, 48, 3], "title": "Simpai 1 Palm Age Distribution", "note": "*Age distribution based on planting year. (Agronomy Report, Pg. 10)" }
                },
                "observations": [
                    "<b>Manuring Delays:</b> The 2024 manuring program was not completed and the 2025 program is slower than expected. This is a key yield-limiting factor. (Agronomy Report, Pg. 4, 11, 49)",
                    "<b>Weeding Program:</b> Spraying progress for both circle and inter-row is slower than expected, impacting ground conditions. (Agronomy Report, Pg. 24, 43, 49)",
                    "<b>Pest Infestation:</b> Rat damage was noted on fresh fruit bunches and palms. Rhinoceros beetle damage in immature areas exceeds the threshold in some blocks. (Agronomy Report, Pg. 28, 39, 45, 46)",
                    "<b>Yield Below Potential:</b> While yield has improved 6% YoY, it remains below potential, especially in blocks PM15A, P16B, and PM20E. (Agronomy Report, Pg. 6, 47)",
                    "<b>Inconsistent Frond Management:</b> Frond heaps are not consistently arranged, which can affect field hygiene and accessibility. (Agronomy Report, Pg. 21, 34)",
                    "<b>Palm Census Needed:</b> An updated palm census is required, especially for immature areas, to ensure accurate fertilizer calculations. (Agronomy Report, Pg. 9, 41)"
                ],
                "reports": {
                    "agronomy": {
                        "Executive Summary": "The first agronomy visit for 2025 was conducted on June 11, 2025. The key concerns are the slow progress of manuring from 2024 carrying into 2025, which is depressing yield potential. Weeding programs are also behind schedule. While overall palm appearance is acceptable, nutrient deficiencies and pest damage (rats, rhinoceros beetles) require immediate attention. Yield has improved but is still below expectations. (Agronomy Report, Pg. 4-7)",
                        "Nutrient Inputs/Progress of Manuring": "The estate failed to complete the 2024 manuring program. The 2025 program is progressing slower than expected, with only 23% of Mix B applied by May due to storage and delivery issues. This is a critical yield-limiting factor. (Agronomy Report, Pg. 11-12)",
                        "Agronomic Observation": "Mature palm appearance is generally acceptable, but some areas show nutrient deficiencies (Pg. 17). Harvesting intervals are satisfactory (<15 days), but unripe bunches were noted (Pg. 15-16). Pruning is timely, but frond heap management is inconsistent (Pg. 19, 21). Weeding is behind schedule, with circle spraying incomplete (Pg. 24). Rat and bagworm damage were observed (Pg. 28-29). Young mature palms show good crop prospect but have some weeding and pest issues (Pg. 30-40). Immature palms are acceptable but affected by weeding delays and pest attacks (Rhinoceros beetle, rats) (Pg. 41-46).",
                        "Yield Performance": "As of May 2025, YTD yield is 5.94 mt/ha, a 6% increase from the same period last year. The most significant gains were in young mature blocks PM20E and PM21F. However, overall yield is below potential, impacted by delays in manuring and weeding. (Agronomy Report, Pg. 47-49)",
                        "Fertilizer Recommendation": "The 2025 fertilizer program remains unchanged. The 2026 program will be formulated in the next report. It is critical to adhere to the current schedule to avoid further yield depression. (Agronomy Report, Pg. 50)"
                    },
                    "plantation": {
                        "Executive Summary": "Based on Concluding Remarks: Harvester numbers are adequate, but sprayers must be recruited to meet program targets. The manuring program must be completed. Rat infestations (19% in some blocks) and VOPs must be addressed urgently. Road maintenance and correction of under-pruned palms are key action items. (Plantation Advisory, Pg. 51)",
                        "Area Statement": "Total plantable area is 1,249.22 ha, consisting of 948.74 ha mature and 300.48 ha immature palms. The replanting program for the estate is now complete. (Plantation Advisory, Pg. 10)",
                        "Labour Statement": "As of May 2025, the estate has 72 workers against a requirement of 80, with a notable shortage of 6 weeders. A contractor will be engaged to cover the shortfall. The overall worker-to-hectare ratio is 1:13, which is satisfactory. (Plantation Advisory, Pg. 11)",
                        "Staff Establishment": "The staff complement is adequate. A new Field Conductor, En. Sarizat, joined in May 2025. (Plantation Advisory, Pg. 12)",
                        "General Charges": "Expenditure as of May 2025 was RM 1,011,408, which is 1% over budget. The variance is due to unbudgeted Head Office salaries and higher statutory contributions from bonus payments. (Plantation Advisory, Pg. 13)",
                        "Upkeep & Cultivation": "Weeding programs are behind schedule (Circle Spraying: 58%, Selective: 55%) due to a shortage of sprayers. Manuring is 82% complete but was delayed. Road grading is significantly behind at only 3% completion. Pruning is 100% complete, but quality issues (under-pruning) persist.",
                        "Harvesting and Collection": "The harvesting and collection cost as of May 2025 is RM 90.71/tonne, which is acceptable. The average harvesting interval is 15 days. Harvester productivity needs to be improved.",
                        "Crop Production": "YTD FFB yield was 7.13 MT/ha, 1% below budget, attributed to rain interference early in the year. Good fruit sets are visible, and average bunch weights have increased compared to the previous year.",
                        "Production Cost": "The cost of production as of May 2025 is RM 323.27 per tonne of FFB, which is considered acceptable at this stage. (Plantation Advisory, Pg. 39)",
                        "Vehicles Running Cost": "All vehicles are outsourced. (Plantation Advisory, Pg. 40)",
                        "Capital Expenditure": "The estate is underspent on its capital budget, having utilized RM 55,168 out of a budgeted RM 176,068. (Plantation Advisory, Pg. 41)",
                        "Immature": "PR22/G (192.63 ha): Weeding is 100% complete, manuring is on track. Basal pruning has commenced (135 ha done). Scout harvesting is ongoing, but loose fruit collection needs better supervision. PR23/H (107.85 ha): Weeding and manuring are behind schedule. Lalang patches require eradication. 388 palms need to be supplied by October."
                    },
                    "pinfosys": {
                        "CEO Financial Summary": "N/A",
                        "Summary of Oil Palm Expenditure": "N/A"
                    }
                },
                "policy": "<p>Policy cross-references are not yet available for this estate.</p>"
            };


            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate();
                    populateInternalDropdowns();
                    attachEventListeners();
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' :
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-red-50 text-red-800' :
                                       metric.title.includes('Weeding') ? 'bg-yellow-50 text-yellow-800' : 'bg-purple-50 text-purple-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Issues & Recommendations</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#c026d3', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#F44336', '#FFC107', '#4CAF50', '#2196F3'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title, font: { size: 16 } }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);
                
                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                 if (pinfosysDiv && estateData.reports.pinfosys) {
                    pinfosysDiv.innerHTML = Object.entries(estateData.reports.pinfosys).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        // Close other open dropdowns
                        container.querySelectorAll('.details-content.active').forEach(openContent => {
                            if (openContent.id !== id) {
                                openContent.classList.remove('active');
                                container.querySelector(`[data-dropdown-id="${openContent.id}"]`).classList.remove('active');
                            }
                        });
                        // Toggle current dropdown
                        content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', openPolicyModal);
            }

            renderEstate();
        });
        
        function openPolicyModal() {
            const modal = document.getElementById('policyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const estateData = {
                "id": "simpai1",
                "name": "Ladang Simpai 1",
                "policy": "<p>Policy cross-references are not yet available for this estate.</p>"
            };
            
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estateData.name}`;
            modalContent.innerHTML = estateData.policy;
            modal.classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
